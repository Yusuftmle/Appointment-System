@page "/register"
@using Application.RequestModels.User.CreateUser;

<div class="register-container">
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>
    
    <div class="register-card">
        <div class="register-header">
            <div class="register-logo">
                <div class="logo-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7.5L12.5 5L9.5 7L3 6.5V9H21ZM12 10.5C10.07 10.5 8.5 12.07 8.5 14S10.07 17.5 12 17.5S15.5 15.93 15.5 14S13.93 10.5 12 10.5ZM19 22H5C4.45 22 4 21.55 4 21V20C4 18.35 5.35 17 7 17H8.5C9.61 17 10.5 16.11 10.5 15H13.5C13.5 16.11 14.39 17 15.5 17H17C18.65 17 20 18.35 20 20V21C20 21.55 19.55 22 19 22Z" fill="currentColor"/>
                    </svg>
                </div>
                <h1>MindCare</h1>
            </div>
            <h2>Yeni Hesap Oluştur</h2>
            <p class="subtitle">Size destek olmak için ilk adımı atın</p>
        </div>

        <EditForm Model="@createUserCommand" OnValidSubmit="RegisterProcess" class="register-form">
            <DataAnnotationsValidator />
            
            <div class="form-row">
                <div class="form-group half-width">
                    <label for="firstName" class="form-label">
                        <span class="label-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12Z" fill="currentColor"/>
                            </svg>
                        </span>
                        Adınız
                    </label>
                    <div class="input-wrapper">
                        <InputText id="firstName" class="form-control" @bind-Value="createUserCommand.firstName" placeholder="Adınızı girin" required />
                        <ValidationMessage For="@(() => createUserCommand.firstName)" class="validation-message" />
                    </div>
                </div>

                <div class="form-group half-width">
                    <label for="lastName" class="form-label">
                        <span class="label-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12Z" fill="currentColor"/>
                            </svg>
                        </span>
                        Soyadınız
                    </label>
                    <div class="input-wrapper">
                        <InputText id="lastName" class="form-control" @bind-Value="createUserCommand.lastName" placeholder="Soyadınızı girin" required />
                        <ValidationMessage For="@(() => createUserCommand.lastName)" class="validation-message" />
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="phoneNumber" class="form-label">
                    <span class="label-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M6.62 10.79C8.06 13.62 10.38 15.94 13.21 17.38L15.41 15.18C15.69 14.9 16.08 14.82 16.43 14.93C17.55 15.3 18.75 15.5 20 15.5C20.55 15.5 21 15.95 21 16.5V20C21 20.55 20.55 21 20 21C10.61 21 3 13.39 3 4C3 3.45 3.45 3 4 3H7.5C8.05 3 8.5 3.45 8.5 4C8.5 5.25 8.7 6.45 9.07 7.57C9.18 7.92 9.1 8.31 8.82 8.59L6.62 10.79Z" fill="currentColor"/>
                        </svg>
                    </span>
                    Telefon Numaranız
                </label>
                <div class="input-wrapper">
                    <InputText id="phoneNumber" class="form-control" @bind-Value="createUserCommand.PhoneNumber" placeholder="0555 123 45 67" required />
                    <ValidationMessage For="@(() => createUserCommand.PhoneNumber)" class="validation-message" />
                </div>
            </div>

            <div class="form-group">
                <label for="email" class="form-label">
                    <span class="label-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M20 4H4C2.9 4 2.01 4.9 2.01 6L2 18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 8L12 13L4 8V6L12 11L20 6V8Z" fill="currentColor"/>
                        </svg>
                    </span>
                    E-posta Adresiniz
                </label>
                <div class="input-wrapper">
                    <InputText id="email" class="form-control" @bind-Value="createUserCommand.Email" placeholder="ornek@email.com" required />
                    <ValidationMessage For="@(() => createUserCommand.Email)" class="validation-message" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group half-width">
                    <label for="password" class="form-label">
                        <span class="label-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M18 8H17V6C17 3.24 14.76 1 12 1S7 3.24 7 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM12 17C10.9 17 10 16.1 10 15S10.9 13 12 13S14 13.9 14 15S13.1 17 12 17ZM15.1 8H8.9V6C8.9 4.29 10.29 2.9 12 2.9S15.1 4.29 15.1 6V8Z" fill="currentColor"/>
                            </svg>
                        </span>
                        Şifreniz
                    </label>
                    <div class="input-wrapper">
                        <InputText id="password" type="password" class="form-control" @bind-Value="createUserCommand.PasswordHash" placeholder="••••••••" required @oninput="ValidatePasswords" />
                        <ValidationMessage For="@(() => createUserCommand.PasswordHash)" class="validation-message" />
                    </div>
                </div>

                <div class="form-group half-width">
                    <label for="confirmPassword" class="form-label">
                        <span class="label-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M9 12L11 14L15 10M21 12C21 16.97 16.97 21 12 21C7.03 21 3 16.97 3 12C3 7.03 7.03 3 12 3C16.97 3 21 7.03 21 12Z" fill="currentColor"/>
                            </svg>
                        </span>
                        Şifre Onayı
                    </label>
                    <div class="input-wrapper">
                        <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="ConfirmPassword" placeholder="••••••••" required @oninput="ValidatePasswords" />
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(PasswordError))
            {
                <div class="alert alert-danger">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22S22 17.52 22 12S17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/>
                    </svg>
                    @PasswordError
                </div>
            }

            @if (!string.IsNullOrEmpty(ErrorText))
            {
                <div class="alert alert-danger">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22S22 17.52 22 12S17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/>
                    </svg>
                    @ErrorText
                </div>
            }

            <ValidationSummary class="validation-summary" />

            <button type="submit" class="btn btn-primary" disabled="@IsSubmitDisabled">
                <span class="btn-content">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7.5L12.5 5L9.5 7L3 6.5V9H21ZM12 10.5C10.07 10.5 8.5 12.07 8.5 14S10.07 17.5 12 17.5S15.5 15.93 15.5 14S13.93 10.5 12 10.5Z" fill="currentColor"/>
                    </svg>
                    Hesap Oluştur
                </span>
            </button>
        </EditForm>

        <div class="register-footer">
            <div class="footer-links">
                <p class="login-redirect">
                    Zaten bir hesabınız var mı? 
                    <a href="/login" class="link-primary">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                            <path d="M10 17L15 12L10 7V10H2V14H10V17Z" fill="currentColor"/>
                        </svg>
                        Giriş Yap
                    </a>
                </p>
            </div>
            <div class="footer-text">
                <p>Kişisel bilgileriniz güvenle saklanır ve kimseyle paylaşılmaz.</p>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    public IUserService? userService { get; set; }
    [Inject]
    public NavigationManager? navigationManager { get; set; }
    
    private CreateUserCommand createUserCommand = new CreateUserCommand();
    private string ErrorText = "";
    private string ConfirmPassword = "";
    private string PasswordError = "";
    private bool IsSubmitDisabled = false;
    private string FullName => $"{createUserCommand.firstName} {createUserCommand.lastName}";

    public async Task RegisterProcess()
    {
        try
        {
            if (createUserCommand.PasswordHash != ConfirmPassword)
            {
                PasswordError = "Şifreler eşleşmiyor. Lütfen kontrol edin.";
                return;
            }

            var result = await userService.CreateUserAsync(createUserCommand);
            navigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            ErrorText = "Kayıt sırasında bir hata oluştu. Lütfen daha sonra tekrar deneyin.";
        }
    }

    private void ValidatePasswords()
    {
        if (string.IsNullOrEmpty(createUserCommand.PasswordHash) && string.IsNullOrEmpty(ConfirmPassword))
        {
            IsSubmitDisabled = false;
            PasswordError = "";
            return;
        }

        if (!string.IsNullOrEmpty(createUserCommand.PasswordHash) && !string.IsNullOrEmpty(ConfirmPassword))
        {
            if (createUserCommand.PasswordHash != ConfirmPassword)
            {
                PasswordError = "Şifreler eşleşmiyor.";
                IsSubmitDisabled = true;
            }
            else
            {
                PasswordError = "";
                IsSubmitDisabled = false;
            }
        }
        else
        {
            IsSubmitDisabled = false;
            PasswordError = "";
        }
    }
}


       