@page "/forgot-password"
@using System.ComponentModel.DataAnnotations
@using Application.Queries.ResetPassword
@using Application.Results
@inject IUserService UserService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="forgot-password-container">
    <div class="forgot-background-shapes">
        <div class="forgot-shape forgot-shape-1"></div>
        <div class="forgot-shape forgot-shape-2"></div>
        <div class="forgot-shape forgot-shape-3"></div>
    </div>

    <div class="forgot-password-card">
        <div class="forgot-password-header">
            <div class="forgot-password-logo">
                <div class="forgot-logo-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,3A4,4 0 0,1 16,7A4,4 0 0,1 12,11A4,4 0 0,1 8,7A4,4 0 0,1 12,3M12,14.5C16.42,14.5 20,16.79 20,19.5V21H4V19.5C4,16.79 7.58,14.5 12,14.5Z" />
                    </svg>
                </div>
                <h1>Sistem</h1>
            </div>
            <h2>Şifremi Unuttum</h2>
            <p class="subtitle">E-posta adresinizi girin, size şifre sıfırlama bağlantısı gönderelim</p>
        </div>

        <EditForm Model="requestModel" OnValidSubmit="HandleRequestPasswordReset" class="login-form">
            <DataAnnotationsValidator />

            <form class="forgot-password-form" id="forgotPasswordForm">
               <div class="forgot-form-group">
                    <label class="forgot-form-label">
                        <span class="forgot-label-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20,8L12,13L4,8V6L12,11L20,6M20,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6C22,4.89 21.1,4 20,4Z" />
                        </svg>
                    </span>
                    E-posta Adresi
                </label>
                </div>
                <div class="forgot-input-wrapper">
                    <InputText @bind-Value="requestModel.Email"
                               type="email"
                               class="form-control"
                               placeholder="E-posta adresinizi girin" />
                </div>
                <ValidationMessage For="() => requestModel.Email" class="validation-message" />
            </form>

            <button type="submit" class="forgot-btn forgot-btn-primary" disabled="@isProcessing">
                <div class="btn-content">
                    @if (isProcessing)
                    {
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="spinner">
                            <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z" />
                        </svg>
                        <span>Gönderiliyor...</span>
                    }
                    else
                    {
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
                        </svg>
                        <span>Şifre Sıfırlama Bağlantısı Gönder</span>
                    }
                </div>
            </button>
        </EditForm>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(isSuccess ? "alert-success" : "alert-danger")">
                @if (isSuccess)
                {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" />
                    </svg>
                }
                else
                {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
                    </svg>
                }
                @message
            </div>
        }

        <div class="forgot-password-footer">
            <div class="forgot-footer-links">
                <a href="/login" class="forgot-link-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                    </svg>
                    Giriş Sayfasına Dön
                </a>
            </div>

            <div class="forgot-footer-text">
                <p>Hesabınızı hatırladınız mı? <a href="/login" class="link-primary" style="text-decoration: none; font-weight: 600;">Giriş Yapın</a></p>
            </div>
        </div>
    </div>
</div>



@code {
    private RequestPasswordResetCommand requestModel = new();
    private bool isProcessing = false;
    private string message = string.Empty;
    private bool isSuccess = false;

    private async Task HandleRequestPasswordReset()
    {
        isProcessing = true;
        message = string.Empty;

        try
        {
            var command = new RequestPasswordResetCommand
                {
                    Email = requestModel.Email
                };

            var response = await RequestPasswordResetAsync(command);

            if (response.Succeeded)
            {
                message = "Şifre sıfırlama bağlantısı e-posta adresinize gönderildi.";
                isSuccess = true;
                requestModel = new RequestPasswordResetCommand(); // Form'u temizle
            }
            else
            {
                message = response.Message ?? "Bir hata oluştu. Lütfen tekrar deneyin.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = "Bir hata oluştu. Lütfen tekrar deneyin.";
            isSuccess = false;
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task<Result> RequestPasswordResetAsync(RequestPasswordResetCommand command)
    {
        return await UserService.RequestPasswordResetAsync(command);
    }
}